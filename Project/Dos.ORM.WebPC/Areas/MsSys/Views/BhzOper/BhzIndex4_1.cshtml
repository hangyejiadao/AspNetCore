
@{
    ViewBag.Title = "BhzIndex4_1";
    Layout = "~/Views/BasePage/_LayoutMsSysEmpty.cshtml";
}


<link href="~/Content/assets/global/daterangepicker/boot/bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/assets/global/daterangepicker/boot/font-awesome.min.css" rel="stylesheet" />
<link href="~/Content/assets/global/daterangepicker/boot/daterangepicker.css" rel="stylesheet" />
<link href="~/Content/Components/echars/css/style.min.css" rel="stylesheet" />
<link href="~/Content/assets/global/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

<script src="~/Content/assets/global/daterangepicker/boot/bootstrap.min.js"></script>
<script src="~/Content/assets/global/daterangepicker/boot/daterangepicker.min.js"></script>
<script src="~/Content/assets/global/daterangepicker/boot/moment.min.js"></script>

<script src="~/Content/Components/echars/echarts.js"></script>
<script src="~/Content/Components/echars/theme/walden.js"></script>

<script src="~/Content/Components/AngularJS/angular.min.js"></script>



<style type="text/css">
    body {
        background-color: rgb(240, 245, 246);
    }
    
    .ibox-title {
        padding: 5px 5px;
        width: 100%;
        min-height: 40px;
        overflow: hidden;
        margin: 5px 5px;
        background-color: #fff;
    }

     .ibox-body {
        position: relative;
        width: 100%;
        height: 95%;
        overflow-x: scroll;
        overflow-y: scroll;
        padding: 0px 0px;
        margin: 0px 5px 0px 5px; /*上  右  下  左*/
        background-color: #fff;
    }
    
    .ibox_echart {
        min-height: 450px;
    }

    .btn-default {
        color: #02a9f3;
        background-color: #fff;
        border: 1px solid #02a9f3;
    }

    .btn-primary {
        color: #fff;
        background-color: #02a9f3;
        border: 1px solid #02a9f3;
    }
    .btn-primary.focus, .btn-primary:focus {
        color: #fff;
        background-color: #02a9f3;
        border: 1px solid #02a9f3;
    }
    .panel-fit, .panel-fit body { 
        overflow-y: scroll;
    }
</style>


<div ng-app="pageApp" ng-controller="pageCtrl">          

    <div class="ibox-title form-inline">

        <div class="input-group input-group-sm">
            <input type="text" ng-model="paramsData.StartEnd" id="F_StartEnd" class="form-control" placeholder="请选择时间" style="width:180px;" />
            <span class="input-group-addon"><i class="fa fa-calendar bigger-110"></i></span>
        </div>

        <div class="input-group input-group-sm">
            <span class="input-group-btn">
                <a href="javascript:;" ng-class="{true:'btn btn-primary',false:'btn btn-default'}[paramsData.PostType==0]" ng-click="queryData(0)">查询</a>
                &nbsp;&nbsp; &nbsp;&nbsp;
                <a href="javascript:;" ng-class="{true:'btn btn-primary',false:'btn btn-default'}[paramsData.PostType==1]" ng-click="queryData(1)">本日</a>
                &nbsp;&nbsp; &nbsp;&nbsp;
                <a href="javascript:;" ng-class="{true:'btn btn-primary',false:'btn btn-default'}[paramsData.PostType==2]" ng-click="queryData(2)">本周</a>
                &nbsp;&nbsp; &nbsp;&nbsp;
                <a href="javascript:;" ng-class="{true:'btn btn-primary',false:'btn btn-default'}[paramsData.PostType==3]" ng-click="queryData(3)">本月</a>
                &nbsp;&nbsp; &nbsp;&nbsp;
                <a href="javascript:;" ng-class="{true:'btn btn-primary',false:'btn btn-default'}[paramsData.PostType==4]" ng-click="queryData(4)">本季</a>
                &nbsp;&nbsp; &nbsp;&nbsp;
                <a href="javascript:;" ng-class="{true:'btn btn-primary',false:'btn btn-default'}[paramsData.PostType==5]" ng-click="queryData(5)">本年</a>
            </span>
        </div>

    </div>
    
    <div class="ibox-body">

        <table class="table table-bordered" ng-if="!show">
            <tbody>
                <tr>
                    <td>暂无数据！</td>
                </tr>
            </tbody>
        </table>

        <table class="table table-bordered" ng-if="show" style="width:99%;font-size:10px">
            <thead>
                <tr>
                    <th style="text-align:center;">强度</th>
                  
                    <th style="text-align:center;" ng-repeat="col in columns">
                        {{::col.QName}}
                    </th>
                </tr>
            </thead>
            <tbody>
              
                <tr>
                    <th style="text-align:center;">
                        盘数
                    </th>
                    <td style="text-align:center;" ng-repeat="col in columns">
                        <div style="font-size:8px" ng-repeat="item in items  | filter:{OrganID: super.OrganID} | filter:{QDDJ: col.QCode}">
                            {{::item.PX}}
                        </div>
                    </td>
                </tr>
                <tr>
                    <th style="text-align:center;">
                        方量
                    </th>
                    <td style="text-align:center;" ng-repeat="col in columns">
                        <div style="font-size:8px" ng-repeat="item in items | filter:{OrganID: super.OrganID} | filter:{QDDJ: col.QCode}">
                            {{::item.SJFL}}
                        </div>
                    </td>
                </tr>                     


            </tbody>
            <tfoot>
               
            </tfoot>
        </table>
        
        <div id="div_one" class="ibox_echart" ng-if="eChart_Data.Result"></div>

    </div>


</div>


<script type="text/javascript">

    var paramsData = {
        "LoadApi": '@ViewBag.LoadApi',
        "OrganID": "",
        "BhzApi": "",
        "PostType": 0,
        "StartEnd": "",
        "StartDate": "",
        "EndDate": ""
    }
        
    $(function () {

    });
      
    //查询数据
    function ModuleQuery(data) {
        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        $scope.paramsData.LoadApi = 1;
        $scope.paramsData.OrganID = data.TargetId;
        $scope.paramsData.BhzApi = data.ExtraData;
        $scope.getCookieData();
        $scope.$apply();
        $scope.queryData(0);
    }
    
    //选择时间查询
    function queryDate(startDate, endDate) {
        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        $scope.paramsData.StartEnd = startDate + ' 至 ' + endDate;
        $scope.paramsData.StartDate = startDate;
        $scope.paramsData.EndDate = endDate;
        $scope.$apply()

        $scope.queryData(0);
    }

    //初始化Angular
    var pageApp = angular.module('pageApp', []);
    pageApp.controller('pageCtrl', function ($scope, $http, $timeout) {
        initNgData($scope, $http);
        initNgEvent($scope, $http, $timeout);
        initNgQuery($scope, $http, $timeout);
       
    });

    //初始化ng数据
    function initNgData($scope, $http) {

        $scope.paramsData = paramsData;
        $scope.paramsData.OrganID = parent.selData.TargetId;
        $scope.paramsData.BhzApi = parent.selData.ExtraData;

        var idxData = parent.idxData;
        if (idxData.idx_mod1 == 3 && idxData.idx_mod2 == 0) {
            $scope.paramsData.LoadApi = 1;
        } else {
            $scope.paramsData.LoadApi = 0;
        }

        $scope.show = true;
        $scope.model = {};
        $scope.items = {};
        $scope.columns = [];
        //$scope.supers = [];

        $scope.eChart_Data = { Result: true };

    }

    //初始化ng事件
    function initNgEvent($scope, $http, $timeout) {
    
        //选择时间设置
        $scope.setDateRange = function () {

            var startDate = $scope.paramsData.StartDate;
            var endDate = $scope.paramsData.EndDate;

            $('#F_StartEnd').daterangepicker(
                   {
                       startDate: startDate,//moment().startOf('day'),
                       endDate: endDate,//moment(),
                       //minDate: '01/01/2012',    //最小时间  
                       maxDate: moment(), //最大时间   
                       //dateLimit: {
                       //    days: 30
                       //}, //起止时间的最大间隔  
                       singleDatePicker: false,
                       showDropdowns: true,
                       showWeekNumbers: false, //是否显示第几周  
                       timePicker: false, //是否显示小时和分钟  
                       timePickerIncrement: 60, //时间的增量，单位为分钟  
                       timePicker12Hour: false, //是否使用12小时制来显示时间                    
                       ranges: {

                           '今日': [moment().startOf('day'), moment()],
                           '昨日': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
                           '最近7日': [moment().subtract('days', 6), moment()],
                           //'最近15日': [moment().subtract('days', 15), moment()],
                           '最近30日': [moment().subtract('days', 29), moment()],
                           '最近3月': [moment().subtract(3, "month").startOf("month"), moment().subtract(1, "month").endOf("month")],
                           '本周': [moment().startOf("week"), moment().endOf("week")],
                           //'上周': [moment().subtract(1, "week").startOf("week"), moment().subtract(1, "week").endOf("week")],
                           '本月': [moment().startOf("month"), moment().endOf("month")],
                           '上月': [moment().subtract(1, "month").startOf("month"), moment().subtract(1, "month").endOf("month")],
                           //'本季': [moment().startOf("QUARTER"), moment().endOf("QUARTER")],
                           '本年': [moment().startOf("year"), moment().endOf("year")],
                           //'上年': [moment().subtract(1, "year").startOf("year"), moment().subtract(1, "year").endOf("year")]
                       },
                       opens: 'right', //日期选择框的弹出位置  
                       buttonClasses: ['btn btn-default'],
                       applyClass: 'btn-small btn-primary blue',
                       cancelClass: 'btn-small',
                       format: 'YYYY-MM-DD', //控件中from和to 显示的日期格式  
                       separator: ' 至 ',
                       autoUpdateInput: false,
                       locale: {
                           applyLabel: '确定',
                           cancelLabel: '取消',
                           fromLabel: '起始时间',
                           toLabel: '结束时间',
                           customRangeLabel: '自定义',
                           daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                           monthNames: ['一月', '二月', '三月', '四月', '五月', '六月',
                                   '七月', '八月', '九月', '十月', '十一月', '十二月'],
                           firstDay: 1
                       }
                   }, function (start, end, label) {//格式化日期显示框   
                       var startDate = start.format('YYYY-MM-DD');
                       var endDate = end.format('YYYY-MM-DD');
                       queryDate(startDate, endDate);
                       QBO.plu.cookie.set("StartEnd", (startDate + ' 至 ' + endDate), { expires: 7, path: '/' });
                   });


        }

        //获取拌合机cookie
        $scope.getCookieData = function () {
            var startEnd = QBO.plu.cookie.get("StartEnd");
            if (startEnd != '') {
                var seDate = startEnd.split(' 至 ');
                $scope.paramsData.StartEnd = startEnd;
                $scope.paramsData.StartDate = seDate[0];;
                $scope.paramsData.EndDate = seDate[1];
            } else {
                var startDate = moment().subtract('days', 6).format('YYYY-MM-DD');
                var endDate = moment().format('YYYY-MM-DD');
                $scope.paramsData.StartEnd = (startDate + ' 至 ' + endDate);
                $scope.paramsData.StartDate = startDate;
                $scope.paramsData.EndDate = endDate;
            }
           
        }

        //查询类型
        $scope.queryData = function (type) {
            $scope.paramsData.PostType = type;
            $scope.loadRptTable();
            $scope.loadRptEchart();
        }
        
        //获取标段
        $scope.initSupers = function () {

            var items = angular.copy($scope.items);

            for (var key in items) {
                if (!CheckSuperExists($scope.supers, items[key])) {
                    var item = {
                        OrganID: items[key].OrganID,
                        OrganName: items[key].OrganName
                    }
                    $scope.supers.push(item);
                }
            }

        }
        
        //产能分析统计
        $scope.loadRptTable = function () {

            if ($scope.paramsData.LoadApi == 0) return;

            QBO.plu.ng.http({ http: $http, method: 'GET', isLoad: true, chkLogin: true, url: '/MsSys/BhzOper/GetBhzRpt1Data', params: $scope.paramsData }, function (data) {
                            
                if (data.Result === 100) {                
                    $scope.show = true;
                    $scope.model = data.Data;
                    $scope.items = $scope.model.items;
                    $scope.columns = $scope.model.columns;
                    if ($scope.columns.length > 0) {
                        var item = { QCode: "total", QName: "合计" }
                        $scope.columns.push(item);
                    }
                    //$scope.supers = [];
                    //$scope.initSupers();
                } else {
                    $scope.show = false;
                    $scope.model = {};
                    $scope.items = {};                  
                    $scope.columns = [];
                    //$scope.supers = [];
                }           

            });
        };
             
        //统计图
        $scope.loadRptEchart = function () {

            if ($scope.paramsData.LoadApi == 0) return;

            QBO.plu.ng.http({ http: $http, method: 'GET', isLoad: false, chkLogin: false, url: '/MsSys/ECharts/GetEChartsRpt1', params: $scope.paramsData }, function (data) {

                if (data != "") {
                    $scope.eChart_Data = JSON.parse(data);

                    if ($scope.eChart_Data.Result) {
                        $timeout(function () {
                            setOption_OneData($scope);
                        });
                    }
                }
                else {
                    $scope.eChart_Data.Result = false;
                }

            });

        }
        
    }
        
    //初始化ng查询数据
    function initNgQuery($scope, $http, $sce) {
        var BhzApi = $scope.paramsData.BhzApi;
        if (BhzApi == null || BhzApi == "") {
            return;
        }
        $scope.getCookieData();

        $scope.queryData(0);

        $scope.setDateRange();

    }
    
    //判断选择参数重复
    function CheckSuperExists(list, item) {
        var rt_value = false;
        if (list == null || list.length == 0) return false;
        for (var key in list) {
            if (list[key].OrganID == item.OrganID) {
                rt_value = true;
                break;
            }
        }
        return rt_value;
    }

    function setOption_OneData($scope) {

        $scope.eChart_Data.ECharts.toolbox = {
            show: true,
            feature: {
                dataView: {
                    show: true,
                    readOnly: true,
                    lang: [$scope.eChart_Data.ECharts.title.text, '关闭', '刷新'],
                    optionToContent: function (opt) {
                        var series = opt.series;
                        var table = '<div style="height: 100%;overflow-y:auto"><table class="table table-striped table-condensed" >'
                                    + '<thead><tr><th>强度等级</th>'
                                    + '<th>' + series[0].name + '(kg)</th>'
                                    + '<th>' + series[1].name + '</th>'
                                    + '</tr></thead>';
                        table += '<tbody>';
                        for (var i in series[0].data) {
                            table += '<tr>'
                                  + '<td>' + series[0].data[i].name + '</td>'
                                  + '<td>' + series[0].data[i].value + 'KG</td>'
                                  + '<td>' + series[1].data[i].value + '</td>'
                                  + '</tr>';
                        }
                        table += '</tbody></table></div>';
                        return table;
                    }
                },
                magicType: { show: true, type: ['line', 'bar'] },
                restore: { show: true },
                saveAsImage: {
                    show: true,
                    backgroundColor: 'white'
                }
            }
        };

        var myChart_One = echarts.init(document.getElementById('div_one'), "walden");

        var series = $scope.eChart_Data.ECharts.series;
        for (var key in series) {
            series[key].label.normal.formatter = function (params) {
                return (params.value || 0).toString().replace(/(\d)(?=(?:\d{3})+$)/g, '$1,');
            };
        }

        myChart_One.setOption($scope.eChart_Data.ECharts);
    }


    function setOption_OneData_Bak($scope) {

        $scope.eChart_Data.ECharts.baseOption.toolbox = {
            show: true,
            feature: {
                dataView: {
                    show: true,
                    readOnly: true,
                    lang: [$scope.eChart_Data.ECharts.baseOption.title.text, '关闭', '刷新'],
                    optionToContent: function (opt) {
                        var series = opt.series;
                        var table = '<div style="height: 100%;overflow-y:auto"><table class="table table-striped table-condensed" >'
                                    + '<thead><tr><th>强度等级</th>'
                                    + '<th>' + series[0].name + '(kg)</th>'
                                    + '<th>' + series[1].name + '</th>'
                                    + '</tr></thead>';
                        table += '<tbody>';
                        for (var i in series[0].data) {
                            table += '<tr>'
                                  + '<td>' + series[0].data[i].name + '</td>'
                                  + '<td>' + series[0].data[i].value + 'KG</td>'
                                  + '<td>' + series[1].data[i].value + '</td>'
                                  + '</tr>';
                        }
                        table += '</tbody></table></div>';
                        return table;
                    }
                },
                magicType: { show: true, type: ['line', 'bar'] },
                restore: { show: true },
                saveAsImage: {
                    show: true,
                    backgroundColor: 'white'
                }
            }
        };

        var myChart_One = echarts.init(document.getElementById('div_one'), "walden");

        var series = $scope.eChart_Data.ECharts.baseOption.series;
        for (var key in series) {
            series[key].label.normal.formatter = function (params) {
                return (params.value || 0).toString().replace(/(\d)(?=(?:\d{3})+$)/g, '$1,');
            };
        }

        myChart_One.setOption($scope.eChart_Data.ECharts);
    }



</script>



