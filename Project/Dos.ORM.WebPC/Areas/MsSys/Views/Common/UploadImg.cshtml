@{
    ViewBag.Title = "上传图片";
    Layout = "~/Views/BasePage/_LayoutMsSysDetailSimple.cshtml";
}
<div data-options="region:'south',border:false" class="frm-toolbar">
    <a href="javascript:;" class="easyui-linkbutton" id="lbtnSave" data-options="iconCls:'icon-save',plain:true">保存</a>
    <a href="javascript:;" class="easyui-linkbutton" id="lbtnCancel" data-options="iconCls:'icon-cancel',plain:true">取消</a>
</div>
<div data-options="region:'center',border:false">
    <link href="~/Content/Components/Uploadify/uploadify.css" rel="stylesheet" />
    <script src="~/Content/Components/Uploadify/jquery.uploadify.min.js"></script>
    <form class="easyui-form" id="frmMain" method="post">
        <table class="frm-tb">
            <tbody>
                <tr>
                    <td>
                        <div class="upload-img-panel" id="upload-img-panel" data-path="" data-chk="0">
                            <img src="~/Content/Images/Common/com_image.png" alt="Quber" id="showImgDefault" />
                        </div>
                    </td>
                </tr>
                <tr>
                    <td style="text-align: inherit;">
                        <div class="fileUploadify">
                            <input id="fileUploadify" type="file" name="ImageFileData" />
                        </div>
                        <a href="javascript:;" style="display: none;" class="easyui-linkbutton" id="lbtnUpload" data-options="iconCls:'icon-moveup',plain:true">确认上传</a>
                        <a href="javascript:;" style="display: none;" class="easyui-linkbutton" id="lbtnCancelUp" data-options="iconCls:'icon-cancel',plain:true">取消上传</a>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="fileUploadify fileUploadify-queue" id="uploadfileQueue"></div>
    </form>
</div>
<script>
    $(function () {
        initData();
        initEvent();
    });

    function initData() {

    }

    function initEvent() {
        var folder = QBO.com.getUrlVal('folder').length <= 0 ? 'Custom' : QBO.com.getUrlVal('folder'),
            isCut = QBO.com.getUrlVal('isCut').length <= 0 ? 0 : parseInt(QBO.com.getUrlVal('isCut')),
            cutWidth = QBO.com.getUrlVal('cutWidth').length <= 0 ? isCut == 1 ? 100 : 0 : QBO.com.getUrlVal('cutWidth'),
            cutHeight = QBO.com.getUrlVal('cutHeight').length <= 0 ? isCut == 1 ? 100 : 0 : QBO.com.getUrlVal('cutHeight'),
            isDelOldImg = QBO.com.getUrlVal('isDelOldImg').length <= 0 ? 1 : parseInt(QBO.com.getUrlVal('isDelOldImg'));

        //上传图片
        QBO.plu.fileUploadify($('#fileUploadify'),
        {
            path: '/Content/Upload/Uploadify/Images/' + folder + '/',
            oldPath: QBO.com.getUrlVal('oldPath'),
            isCut: isCut, cutWidth: cutWidth, cutHeight: cutHeight,
            isDelOldImg: isDelOldImg
        });

        $('#lbtnUpload').on('click', function () {
            //上传第一个文件
            //$('#fileUploadify').uploadify('upload');
            //上传队列所有文件
            $('#fileUploadify').uploadify('upload', '*');
        });
        $('#lbtnCancelUp').on('click', function () {
            //取消第一个文件上传
            //$('#fileUploadify').uploadify('cancel');
            //取消队列所有文件上传
            $('#fileUploadify').uploadify('cancel', '*');
        });
        $('#lbtnSave').on('click', function () {
            if (!checkIsChanged()) {
                QBO.dia.tip('请先上传图片！', 'error');
                return;
            }

            QBO.frm.getWin('lay').setImg($('#upload-img-panel').data('path'));
            QBO.frm.closeWin();
        });
        $('#lbtnCancel').on('click', function () {
            if (checkIsChanged()) {
                QBO.dia.confirm('图片尚未保存，确定要关闭？', function () {
                    QBO.formClick.closeTopWin('upload');
                });
            } else {
                QBO.frm.closeWin();
            }
        });
    }

    function checkIsChanged() {
        return $('#upload-img-panel').data('chk') != '0';
    }
</script>
