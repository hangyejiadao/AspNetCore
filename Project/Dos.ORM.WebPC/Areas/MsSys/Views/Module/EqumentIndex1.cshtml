
@{
    ViewBag.Title = "EqumentIndex1";
    Layout = "~/Views/BasePage/_LayoutMsSysEmpty.cshtml";
}
<link href="~/Content/Components/Bootstrap/css/bootstrap.min.css" rel="stylesheet" />

<script src="~/Content/Components/AngularJS/angular.min.js"></script>

<script src="~/Content/Js/Base/jpager.js"></script>

<style type="text/css">
    body {
        background-color: #fff;
        font-size:12px;
    }

    .ibox-title {
        position: absolute;
        height: 50px;
        padding: 10px 10px;
    }

    .ibox-body {
        position: absolute;
        top: 50px;
        width: 100%;
        height: 90%;
        overflow-x: hidden;
        overflow-y: auto;
        padding: 5px 5px;
        margin: 0px 0px;
        background-color: rgb(240, 245, 246);
        display: inline;
    }


    .ibox-bottom {
        position: absolute;
        height: 30px;
        bottom: 50px;
        padding: 5px 5px;
        border-bottom: 0px solid transparent;
        border-top-left-radius: 3px;
        border-top-right-radius: 3px;
        text-align: left;
    }
</style>

<div ng-app="pageApp" ng-controller="pageCtrl">
    <div class="ibox-title">

        <div class="row">
            <div class="col-sm-12 col-xs-12 col-md-12 col-lg-12">

                <span class="titleFont">
                    <a href="EqumentIndex?TargetId={{queryCon.TargetId}}&LoadApi=1" target="_self">
                        <i class="fa fa-list" title="切换为列表模式"></i>
                    </a>
                </span>

                功能室：
                <input id="F_EquType" name="F_EquType" class="easyui-combobox" style="width: 150px;"> 

                关键字：<input id="F_FilterText" type="text" placeholder="名称/编号" ng-model="queryCon.FilterText"
                           style="width:120px;padding: 5px 2px;line-height: 1.3; background-color: #fff; border: 1px solid #ccc;" />

                <a href="javascript:;" ng-click="queryData()"
                   class="easyui-linkbutton" data-options="iconCls:'fa fa-search-plus',plain:false">查询</a>
            </div>
        </div>


    </div>

    <div class="container-fluid ibox-body">
        <div class="row" ng-repeat="list in items">
            <div ng-repeat="item in list"
                 class="col-sm-2 col-xs-2 col-md-2 col-lg-2" style="text-align:center">

                <div style="margin:5px 5px;padding:5px 5px;background-color:#fff;">
                    <img ng-src="{{item.FilePath!=null?item.FilePath:'/Content/Css/Themes/Images/Design/Default/IconBig/main_nav_jcsb.png'}}" style="height:100px;width:100px;">
                    <br><br>
                    <p><span class="c-label">设备编号:</span>{{::item.EquipmentNO}}</p>
                    <p><span class="c-label">设备名称:</span>{{::item.EquipmentName}}</p>                                      
                </div>

            </div>
        </div>

        <div class="row">

            <div class="col-sm-12 col-xs-12 col-md-12 col-lg-12" style="text-align:center">
                <nav aria-label="Page navigation">
                    <ul class="pagination"></ul>
                </nav>

            </div>
        </div>

    </div>


</div>

<script type="text/javascript">


    var gridObj, gdKeyId = 'ID'; paramsData = { page: 1, rows: 30, total: 0, LoadApi: '@ViewBag.LoadApi', TargetId: '@ViewBag.TargetId', EquType: '', FilterText: '' }

    $(function () {

    });


    //初始化Angular
    var pageApp = angular.module('pageApp', []);
    pageApp.controller('pageCtrl', function ($scope, $http, $timeout) {
        initNgData($scope, $http);
        initNgEvent($scope, $http, $timeout);
    });

    //初始化ng数据
    function initNgData($scope, $http) {
        $scope.loadData = [];
        $scope.items = [];
        $scope.queryCon = paramsData;

        //$scope.queryData();
    }

    //初始化ng事件
    function initNgEvent($scope, $http, $timeout) {


        if ($scope.queryCon.LoadApi == 1) {
            load_Type($scope);
            Load_Data($scope, $http, $timeout);
        }

        $scope.queryData = function () {
            Load_Data($scope, $http, $timeout);
        };

        $scope.queryType = function () {
            load_Type($scope);
        };


    }

    function Load_Data($scope, $http, $timeout) {

        $scope.queryCon.EquType = $('#F_EquType').combobox('getValue');
        $scope.queryCon.FilterText = $('#F_FilterText').val();

        QBO.plu.ng.http({ http: $http, method: 'POST', isLoad: false, chkLogin: true, url: '/MsSys/Module/GetEqument', params: $scope.queryCon }, function (data) {

            //console.log(JSON.stringify(data));

            if (data.rows.length > 0) {
                $scope.loadData = data.rows;
                $scope.items = [];
                $scope.queryCon.total = data.total;
                init_Data($scope)
            }
            else {
                $scope.loadData = [];
                $scope.items = [];
                $scope.queryCon.total = 0;
            }



            $(".pagination").jpager({
                showFirstLast: true,
                currentPage: $scope.queryCon.page,
                totalItems: $scope.queryCon.total,
                links: 5,
                limit: $scope.queryCon.rows,
                pageGo: function (page, offset, limit) {
                    $scope.queryCon.page = page;
                    $scope.queryCon.rows = limit;
                    //$scope.search(page);

                    var totapage = $scope.queryCon.total % $scope.queryCon.rows != 0 ? ($scope.queryCon.total / $scope.queryCon.rows + 1) : $scope.queryCon.total / $scope.queryCon.rows;

                    if (page <= totapage) {
                        Load_Data($scope, $http, $timeout)
                    }

                    if (!$scope.$$phase) {
                        $scope.$apply();
                    }
                }
            });


        });
    };

    function init_Data($scope) {
        var data = angular.copy($scope.loadData);

        var list = [];
        var index = 6;
        for (var i = 0; i < data.length; i++) {
            index--;
            list.push(data[i]);
            if (index == 0) {
                $scope.items.push(list);
                index = 6;
                list = [];
            }
        }

        if (index != 0) {
            $scope.items.push(list);
        }

        //console.log(JSON.stringify($scope.items));




    }

    function load_Type($scope) {

        $('#F_EquType').combobox({
            url: '/MsSys/Module/GetEquTypeList',
            queryParams: { TargetId: paramsData.TargetId },
            method: 'get',
            editable: false,
            required: false,
            onSelect: function (rec) {
                $('#F_EquType').combobox('setValue', rec.value);
                $scope.queryData();
            }
        });


        //$('#F_EquType').combobox({
        //    url: '/MsSys/Module/GetEquTypeList',
        //    queryParams: { TargetId: $scope.queryCon.TargetId },
        //    method: 'get',
        //    valueField: 'EquipmentTypeName',
        //    textField: 'EquipmentTypeName',
        //    editable: false,
        //    required: false,
        //    icons: [{
        //        iconCls: 'icon-clear',
        //        handler: function (e) {
        //            $(e.data.target).combobox('clear');
        //        }
        //    }]
        //});

    }



    function ModuleQuery(data) {

        //alert("查询数据" + JSON.stringify(data));

        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        paramsData.LoadApi = 1;
        paramsData.TargetId = data.TargetId;

        $scope.queryType();

        $scope.queryData();
    }


</script>