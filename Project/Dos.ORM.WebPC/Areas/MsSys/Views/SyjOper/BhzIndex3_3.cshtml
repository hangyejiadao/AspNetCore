@{
    ViewBag.Title = "BhzIndex3_3";
    Layout = "~/Views/BasePage/_LayoutMsSysEmpty.cshtml";
}

<link href="~/Content/Components/echars/css/style.min.css" rel="stylesheet" />
<link href="~/Content/assets/global/bootstrap/css/bootstrap.css" rel="stylesheet" />
<link href="~/Content/assets/global/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />

@*<script src="~/Content/assets/global/bootstrap/js/bootstrap.min.js"></script>*@

<script src="~/Content/assets/global/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
@*<script src="~/Content/assets/global/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.fr.js"></script>*@

<script src="~/Content/Components/echars/echarts.js"></script>
<script src="~/Content/Components/echars/theme/walden.js"></script>

<script src="~/Content/Components/AngularJS/angular.min.js"></script>

<style type="text/css">
    body {
        background-color: rgb(240, 245, 246);
    }

    .ibox-title {
        padding: 5px 5px;
        width: 100%;
        min-height: 40px;
        overflow: hidden;
        margin: 5px 5px;
        background-color: #fff;
    }

    .ibox-body {
        position: relative;
        width: 100%;
        height: 95%;
        overflow-x: auto;
        overflow-y: auto;
        padding: 0px 0px;
        margin: 0px 5px 5px 5px; /*上  右  下  左*/
        background-color: #fff;
    }

    .ibox_echart {
        min-height: 450px;
    }

    .btn-default {
        color: #02a9f3;
        background-color: #fff;
        border: 1px solid #02a9f3;
    }

    .btn-primary {
        color: #fff;
        background-color: #02a9f3;
        border: 1px solid #02a9f3;
    }

        .btn-primary.focus, .btn-primary:focus {
            color: #fff;
            background-color: #02a9f3;
            border: 1px solid #02a9f3;
        }

    .panel-fit, .panel-fit body {
        overflow-y: scroll;
    }
</style>


<div ng-app="pageApp" ng-controller="pageCtrl">

    <div class="ibox-title form-inline">
        <div class="input-group input-group-sm date form_datetime">
            <input type="text" class="form-control" ng-model="paramsData.Year" placeholder="选择时间" style="width:60px;" />
            <span class="input-group-addon"><i class="fa fa-calendar bigger-110"></i></span>
        </div>

        <div class="form-group input-group-sm">
            <select class="form-control" ng-model="paramsData.GradeCode" ng-change="queryData()">
                <option selected="selected" value="">强度等级</option>
                <option value="C10">C10</option>
                <option value="C15">C15</option>
                <option value="C20">C20</option>
                <option value="C25">C25</option>
                <option value="C30">C30</option>
                <option value="C35">C35</option>
                <option value="C40">C40</option>
                <option value="C45">C45</option>
                <option value="C50">C50</option>
                <option value="C55">C55</option>
                <option value="C60">C60</option>
                <option value="C65">C65</option>
                <option value="C70">C70</option>
                <option value="C75">C75</option>
                <option value="C80">C80</option>
                <option value="C85">C85</option>
                <option value="other">其他</option>
            </select>
        </div>


        <div class="form-group input-group-sm">
            <a href="javascript:;" class="btn btn-sm btn-primary" ng-click="queryData()">查询</a>
        </div>

    </div>

    <div class="ibox-body">

        <table class="table table-condensed table-bordered" ng-if="items.length==0">
            <tbody>
                <tr>
                    <td>暂无数据！</td>
                </tr>
            </tbody>
        </table>

        <table class="table table-condensed table-bordered" ng-if="items.length>=1">
            <tbody>
                <tr>
                    <th style="text-align:center;">月份</th>
                    <th ng-repeat="item in items" style="text-align:center;">{{::item.Month}}月</th>
                </tr>
                <tr>
                    <th style="text-align:center;">检测总数</th>
                    <td ng-repeat="item in items" style="text-align:center;">{{::item.Qty1}}</td>
                </tr>
                <tr>
                    <th style="text-align:center;">合格数量</th>
                    <td ng-repeat="item in items" style="text-align:center;">{{::item.Qty2}}</td>
                </tr>
                <tr>
                    <th style="text-align:center;">合格率(%)</th>
                    <td ng-repeat="item in items" style="text-align:center;">{{::(item.Qty1==0)?'':(item.Qty2/item.Qty1*100).toFixed(2)}}</td>
                </tr>
            </tbody>
        </table>

        <div id="div_one" class="ibox_echart" ng-if="eChart_Data.Result"></div>

      
    </div>

</div>


<script type="text/javascript">

    var paramsData = {
        "BhzApi": "",
        "LoadApi": '@ViewBag.LoadApi',
        "OrganID": "",
        "TestType": "HNT",
        "Year": "",
        "GradeCode": ""
    }

    $(function () {

    });

    //查询数据
    function ModuleQuery(data) {
        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        $scope.paramsData.LoadApi = 1;
        $scope.paramsData.OrganID = data.TargetId;
        $scope.paramsData.BhzApi = data.ExtraData;

        $scope.$apply();
        $scope.queryData();
    }
     
    //选择时间查询
    function queryDate(year) {
        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        $scope.paramsData.Year = year;
        $scope.$apply()
        $scope.queryData();
    }


    //初始化Angular
    var pageApp = angular.module('pageApp', []);
    pageApp.controller('pageCtrl', function ($scope, $http, $timeout) {
        initNgData($scope, $http);
        initNgEvent($scope, $http, $timeout);
        initNgQuery($scope, $http, $timeout);
    });

    //初始化ng数据
    function initNgData($scope, $http) {

        $scope.paramsData = paramsData;
        $scope.paramsData.OrganID = parent.selData.TargetId;
        $scope.paramsData.BhzApi = parent.selData.ExtraData;
        $scope.paramsData.Year = new Date().getFullYear();

        var idxData = parent.idxData;
        if (idxData.idx_mod1 == 2 && idxData.idx_mod2 == 2) {
            $scope.paramsData.LoadApi = 1;
        } else {
            $scope.paramsData.LoadApi = 0;
        }

        $scope.items = [];
        $scope.eChart_Data = { Result: true };

    }

    //初始化ng事件
    function initNgEvent($scope, $http, $timeout) {

        //选择时间设置
        $scope.setDateRange = function () {

            $('.form_datetime').datetimepicker({
                format: 'yyyy',
                autoclose: true,
                startView: 4,
                maxView: 4,
                minView: 4,
                forceParse: true,
                language: 'zh-CN'
            })
            .on('changeYear', function (ev) {
                queryDate(ev.date.getFullYear());
            });

        }

       
        //查询类型
        $scope.queryData = function () {        
            $scope.loadRptTable();
            $scope.loadRptEchart();
        }

        //统计表
        $scope.loadRptTable = function () {

            if ($scope.paramsData.LoadApi != 1) return;
            $scope.items = [];
            QBO.plu.ng.http({ http: $http, method: 'POST', isLoad: true, chkLogin: true, url: '/MsSys/SyjOper/GetHNTRpt3Data', params: $scope.paramsData }, function (data) {
                if (data.Result === 100) {
                    $scope.items = data.Data;
                } else {
                    $scope.items = [];
                }
            });
        };

        //统计图
        $scope.loadRptEchart = function () {

            if ($scope.paramsData.LoadApi != 1) return;
            $scope.eChart_Data = { Result: true };
            QBO.plu.ng.http({ http: $http, method: 'GET', isLoad: false, chkLogin: false, url: '/MsSys/SyjOper/GetHNTRpt3EChart', params: $scope.paramsData }, function (data) {

                if (data != "") {
                    $scope.eChart_Data = JSON.parse(data);

                    if ($scope.eChart_Data.Result) {
                        $timeout(function () {
                            setOption_OneData($scope);
                        });
                    }
                }
                else {
                    $scope.eChart_Data.Result = false;
                }

            });
        }

    }


    //初始化ng查询数据
    function initNgQuery($scope, $http, $sce) {

        var BhzApi = $scope.paramsData.BhzApi;
        if (BhzApi == null || BhzApi == "") {
            return;
        }

        $scope.queryData();

        $scope.setDateRange();

    }

    function setOption_OneData($scope) {
        $scope.eChart_Data.ECharts.toolbox = {
            show: true,
            feature: {
                dataView: {
                    show: true,
                    readOnly: true,
                    lang: [$scope.eChart_Data.ECharts.title.text, '关闭', '刷新'],
                    optionToContent: function (opt) {
                        var series = opt.series;
                        var table = '<div style="height: 100%;overflow-y:auto"><table class="table table-striped table-condensed" >'
                                    + '<thead><tr><th>月份</th>'
                                    + '<th>' + series[0].name + '</th>'
                                    + '<th>' + series[1].name + '</th>'
                                    + '</tr></thead>';

                        table += '<tbody>';
                        for (var i in series[0].data) {
                            table += '<tr>'
                                  + '<td>' + series[0].data[i].name + '</td>'
                                  + '<td>' + series[0].data[i].value + '</td>'
                                  + '<td>' + series[1].data[i].value + '</td>'
                                  + '</tr>';
                        }

                        table += '</tbody></table></div>';
                        return table;
                    }
                },
                magicType: { show: true, type: ['line', 'bar'] },
                restore: { show: true },
                saveAsImage: {
                    show: true,
                    backgroundColor: 'white'
                }
            }
        };

        var myChart_One = echarts.init(document.getElementById('div_one'), "walden");

        myChart_One.setOption($scope.eChart_Data.ECharts);

        //console.log(JSON.stringify($scope.eChart_Data.ECharts))
    }


</script>




