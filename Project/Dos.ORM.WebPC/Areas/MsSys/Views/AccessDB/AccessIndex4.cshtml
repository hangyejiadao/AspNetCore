@{
    ViewBag.Title = "AccessIndex4";
    Layout = "~/Views/BasePage/_LayoutMsSysList.cshtml";
}
<script src="~/Content/Js/Module/Business/functions.js"></script>
<div id="toolBarMain" class="list-toolbar">

    <div class="row">

        试验日期: <input id="F_StartDate" type="text" class="easyui-datebox" data-options="required:false,width:100,height:28,readonly:false,disabled:false,editable:false" />

        至:<input id="F_EndDate" type="text" class="easyui-datebox" data-options="required:false,width:100,height:28,readonly:false,disabled:false,editable:false" />

        样品编号：<input id="F_SampleNum" class="easyui-textbox" data-options="type:'text',required:false,isShowFill:true,width:120,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false" />

        工程部位用途：<input id="F_PlacePurpose" class="easyui-textbox" data-options="type:'text',required:false,isShowFill:true,width:120,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false" />

        强度等级：<input id="F_StrengthGrade" class="easyui-textbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false" />

        龄期(天)：<input id="F_AgeDays" class="easyui-numberbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false,min:0,precision:0">

        @*28天达到强度等级比例：
            <input id="F_StartScale" class="easyui-numberbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false,min:0,precision:2">
            % ～
            <input id="F_EndScale" class="easyui-numberbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false,min:0,precision:2">
            %*@

        <a href="javascript:;" class="easyui-linkbutton" id="lbtnSearch" data-options="iconCls:'fa fa-search-plus',plain:false">查询</a>

    </div>
</div>


<script type="text/javascript">

    var gridObj, gdKeyId = 'ID';
    var paramsData = {
        "LoadApi": '@ViewBag.LoadApi',
        "OrganID": '@ViewBag.TargetId',
        "TableType": 0,
        "TypeCode": "'100131','SNSJ','100133','63','JZSJ'",
        "StartDate": "",
        "EndDate": "",
        "SampleNum": "",
        "PlacePurpose": "",
        "StrengthGrade": "",
        "AgeDays": ""
    }

    $(function () {
        SetTime();
        initData();
        initEvent();
    });


    function SetTime() {
        var curr_time = new Date();
        $('#F_StartDate').datebox('setValue', dateformatter(curr_time));
        var next_time = DateAdd("m ", 1, curr_time);
        $('#F_EndDate').datebox('setValue', dateformatter(next_time));
    };

    function ModuleQuery(data) {
        //alert("查询数据" + JSON.stringify(data));
        paramsData.LoadApi = 1;
        paramsData.OrganID = data.TargetId;
        queryData();
    }
    
    //查询数据
    function queryData() {

        paramsData.StartDate = $('#F_StartDate').datebox('getValue');
        paramsData.EndDate = $('#F_EndDate').datebox('getValue');
        paramsData.SampleNum = $('#F_SampleNum').textbox('getValue');
        paramsData.PlacePurpose = $('#F_PlacePurpose').textbox('getValue');
        paramsData.StrengthGrade = $('#F_StrengthGrade').textbox('getValue');
        paramsData.AgeDays = $('#F_AgeDays').numberbox('getValue');
        //paramsData.StartScale = $('#F_StartScale').numberbox('getValue');
        //paramsData.EndScale = $('#F_EndScale').numberbox('getValue');

        QBO.plu.grid.query(gridObj, paramsData);

    }

    function initData() {
        gridObj = $('#dg');

        paramsData.StartDate = $('#F_StartDate').datebox('getValue');
        paramsData.EndDate = $('#F_EndDate').datebox('getValue');

        QBO.plu.grid.init(gridObj, {
            keyId: gdKeyId,
            queryParams: paramsData,
            //method:'GET',
            pageSize: 30,
            singleSelect: true,
            url: '/MsSys/AccessDB/GetAccessData',
            colFro: [
                {
                    field: 'SJBH', title: '样品编号', width: 180, align: 'center',
                    formatter: function (value, row, index) {
                        var r_value = "<a href=\'#\' style=\'color:#31b0d5\' onclick=\'ViewWin(\"" + row.SYLX + "\",\"" + row.SYJID + "\",\"" + row.URL + "\")\'>" + value + "</a>";
                        return r_value
                    }
                }
            ],
            col: [
                { field: 'CJMC', title: '工程部位用途', width: 300 },
                { field: 'SJQD', title: '强度等级', width: 100, align: 'center' },
                { field: 'LQ', title: '龄期(天)', width: 100, align: 'center' },
                { field: 'SJCC', title: '试件尺寸(mm)', width: 150 },
                { field: 'Field1', title: '抗压强度(MPa)', width: 100, formatter: formatMPa },
                { field: 'Field2', title: '达到设计强度百分比(%)', width: 140 },
                {
                    field: 'Field3', title: '是否合格', width: 100,
                    styler: function (value, row, index) {
                        if (value == "不合格") {
                            return 'color:red;';
                        }
                    }
                },
                { field: 'SYRQ', title: '试验日期', width: 100, align: 'center', formatter: QBO.plu.grid.formatShortDate },
                { field: 'Oper', title: '操作', width: 100, align: 'center', formatter: formatOper }
            ],
            toolbar: 'toolBarMain',
            onLoadSuccess: function (data) {                          
                $("span.eui-opt-acc").imgPreview();
            }
        });
    }

    function initEvent() {
        $('#lbtnSearch').linkbutton({ onClick: function () { doHanlder('search'); } });
    }

    function doHanlder(type) {
        switch (type) {
            case 'search':
                queryData();
                break;
        }
    }

    //查看
    function ViewWin(type, id, url) {

        //"'100131','100133'",

        var page = "";

        if (type == "100131"||type == "SNSJ") {
            page = "KY_SJ.aspx";
        }
        else if (type == "100133"||type == "63"||type == "JZSJ") {
            page = "KY_JZSJ.aspx";
        }

        if (page != "") {
            var newurl = url + "/Module/Caiji/" + page + "?syjid=" + id + "&sylx=" + type;

            QBO.frm.openWin(newurl, { title: '查看详细', isFull: true });
        }
    }


    function formatOper(value, row, index) {
        var name = "<i class=\'fa fa-file-text-o\' title=\'查看\' style=\'color: rgb(80, 185, 255);\'></i>"

        var R_Value = "<a href=\'#\' onclick=\'ViewWin(\"" + row.SYLX + "\",\"" + row.SYJID + "\",\"" + row.URL + "\")\'>" + name + "</a>";

        return R_Value;

    }

    //抗压强度(MPa)
    function formatMPa(value, row, index) {

        var r_value1 = "";
        var r_value2 = "";
        var r_value3 = "";
      
        try {

            var kylz = row.KYLZ;//荷载值910.6，824.5，739.8
            var sjcc = row.SJCC;//150×150×150
            if(sjcc=="70.7*70.7*70.7"||sjcc=="70.7mm×70.7mm×70.7mm")
			{
				sjcc="70.7×70.7×70.7";
			}
            if (kylz !== null && kylz !== undefined && kylz !== '') {

                var arr_kylz = kylz.split('，');

                if (arr_kylz.length == 6) {

                    var area = GetNum(sjcc);//150×150×150=3375000

                    var arr = new Array(6);
                    for (var i = 0; i < 6; i++) {

                        arr[i] = GetDataOddIncreaseEvenDecrease((parseFloat(arr_kylz[i]) * 1000 / area), -1);
                    }

                    arr.sort(function (a, b) { return a > b ? 1 : -1 });

                    var avg = (parseFloat(arr[0]) + parseFloat(arr[1]) + parseFloat(arr[2]) + parseFloat(arr[3]) + parseFloat(arr[4]) + parseFloat(arr[5])) / 6;

                    r_value1 = GetDataOddIncreaseEvenDecrease(avg, -1);

                    var sjqd = parseFloat(row.SJQD.replace("M", ""));//强度等级

                    if (r_value1 != "") {
                        r_value2 = (r_value1 / sjqd * 100).toFixed(2);
                        r_value3 = (row.LQ != 28 ? "-" : (r_value2 > 100 ? "合格" : "不合格"));
                    } else {
                        r_value1 = "";
                        r_value2 = "";
                        r_value3 = "";
                    }
                } else {
                    r_value1 = "";
                    r_value2 = "";
                    r_value3 = "";
                }
            }
            else {
                r_value1 = "";
                r_value2 = "";
                r_value3 = "";
            }

        } catch (e) {
            r_value1 = "";
            r_value2 = "";
            r_value3 = "";
        }
        
        row.Field1 = r_value1;
        row.Field2 = r_value2;
        row.Field3 = r_value3;

        return r_value1;

    }

</script>



@*扩展定义*@
<script type="text/javascript">

    function dateformatter(date) {
        var y = date.getFullYear();
        var m = date.getMonth();
        var d = date.getDate();
        return y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d);
    }

    function DateAdd(interval, number, date) {
        /*
          *   功能:实现VBScript的DateAdd功能.
          *   参数:interval,字符串表达式，表示要添加的时间间隔.
          *   参数:number,数值表达式，表示要添加的时间间隔的个数.
          *   参数:date,时间对象.
          *   返回:新的时间对象.
          *   var   now   =   new   Date();
          *   var   newDate   =   DateAdd( "d ",5,now);
          *---------------   DateAdd(interval,number,date)   -----------------
          */
        switch (interval) {
            case "y ": {
                date.setFullYear(date.getFullYear() + number);
                return date;
                break;
            }
            case "q ": {
                date.setMonth(date.getMonth() + number * 3);
                return date;
                break;
            }
            case "m ": {
                date.setMonth(date.getMonth() + number);
                return date;
                break;
            }
            case "w ": {
                date.setDate(date.getDate() + number * 7);
                return date;
                break;
            }
            case "d ": {
                date.setDate(date.getDate() + number);
                return date;
                break;
            }
            case "h ": {
                date.setHours(date.getHours() + number);
                return date;
                break;
            }
            case "m ": {
                date.setMinutes(date.getMinutes() + number);
                return date;
                break;
            }
            case "s ": {
                date.setSeconds(date.getSeconds() + number);
                return date;
                break;
            }
            default: {
                date.setDate(d.getDate() + number);
                return date;
                break;
            }
        }
    }


</script>