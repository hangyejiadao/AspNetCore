@{
    ViewBag.Title = "AccessIndex1";
    Layout = "~/Views/BasePage/_LayoutMsSysList.cshtml";
}
<script src="~/Content/Js/Module/Business/functions.js"></script>
<div id="toolBarMain" class="list-toolbar">

    <div class="row">
        
        试验日期: <input id="F_StartDate" type="text" class="easyui-datebox" 
                     data-options="required:false,width:100,height:28,readonly:false,disabled:false,editable:false" />
       
        至:<input id="F_EndDate" type="text" class="easyui-datebox" data-options="required:false,width:100,height:28,readonly:false,disabled:false,editable:false" />
       
        样品编号：<input id="F_SampleNum" class="easyui-textbox" data-options="type:'text',required:false,isShowFill:true,width:120,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false" />
      
        工程部位用途：<input id="F_PlacePurpose" class="easyui-textbox" data-options="type:'text',required:false,isShowFill:true,width:120,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false" />

        强度等级：<input id="F_StrengthGrade" class="easyui-textbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false" />
      
        龄期(天)：<input id="F_AgeDays" class="easyui-numberbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false,min:0,precision:0">
       
         @*28天达到强度等级比例：
        <input id="F_StartScale" class="easyui-numberbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false,min:0,precision:2">
        % ～
        <input id="F_EndScale" class="easyui-numberbox" data-options="type:'text',required:false,isShowFill:true,width:60,height:28,tipPosition:'right',readonly:false,buttonAlign:'right',multiline:false,iconAlign:'right',disabled:false,min:0,precision:2">
        %*@
      
        <a href="javascript:;" class="easyui-linkbutton" id="lbtnSearch" data-options="iconCls:'fa fa-search-plus',plain:false">查询</a>

    </div>

</div>




<script type="text/javascript">

    var gridObj, gdKeyId = 'ID';
    var paramsData = {
        "LoadApi": '@ViewBag.LoadApi',
        "OrganID": '@ViewBag.TargetId',
        "TableType": 0,
        "TypeCode": "'100014','61','HNTKY','PSHNTKY','TYH'",
        "StartDate": "",
        "EndDate": "",
        "SampleNum": "",
        "PlacePurpose": "",
        "StrengthGrade": "",
        "AgeDays": "",
        //"StartScale": 0,
        //"EndScale": 0

    }

    $(function () {
        SetTime();
        initData();
        initEvent();
    });


    function SetTime() {
        var curr_time = new Date();
        $('#F_StartDate').datebox('setValue', dateformatter(curr_time));
        var next_time = DateAdd("m ", 1, curr_time);
        $('#F_EndDate').datebox('setValue', dateformatter(next_time));
    };

    function ModuleQuery(data) {
        //alert("查询数据" + JSON.stringify(data));
        paramsData.LoadApi = 1;
        paramsData.OrganID = data.TargetId;
        queryData();
    }


    //查询数据
    function queryData() {
       
        paramsData.StartDate = $('#F_StartDate').datebox('getValue');
        paramsData.EndDate = $('#F_EndDate').datebox('getValue');
        paramsData.SampleNum = $('#F_SampleNum').textbox('getValue');
        paramsData.PlacePurpose = $('#F_PlacePurpose').textbox('getValue');
        paramsData.StrengthGrade = $('#F_StrengthGrade').textbox('getValue');
        paramsData.AgeDays = $('#F_AgeDays').numberbox('getValue');
        //paramsData.StartScale = $('#F_StartScale').numberbox('getValue');
        //paramsData.EndScale = $('#F_EndScale').numberbox('getValue');

        //isload = 0;
        QBO.plu.grid.query(gridObj, paramsData);

    }

    //var isload = 0;

    function initData() {
        gridObj = $('#dg');

        paramsData.StartDate = $('#F_StartDate').datebox('getValue');
        paramsData.EndDate = $('#F_EndDate').datebox('getValue');

        QBO.plu.grid.init(gridObj, {
            keyId: gdKeyId,
            queryParams: paramsData,
            //method:'GET',
            pageSize: 30,
            singleSelect: true,
            //nowrap: false,
            url: '/MsSys/AccessDB/GetAccessData',
            colFro: [                
                {
                    field: 'SJBH', title: '样品编号', width: 180, align: 'center',
                    formatter: function (value, row, index) {
                        var r_value = "<a href=\'#\' style=\'color:#31b0d5\' onclick=\'ViewWin(\"" + row.SYJID + "\",\"" + row.URL + "\")\'>" + value + "</a>";
                        return r_value
                    }
                }
            ],
            col: [
                { field: 'CJMC', title: '工程部位用途', width: 300 },
                { field: 'SJQD', title: '强度等级', width: 100, align: 'center' },
                { field: 'LQ', title: '龄期(天)', width: 100, align: 'center' },
                { field: 'SJCC', title: '试件尺寸(mm)', width: 150 },
                { field: 'Field1', title: '抗压强度(MPa)', width: 100, formatter: formatMPa },
                { field: 'Field2', title: '达到设计强度百分比(%)', width: 140 },
                {
                    field: 'Field3', title: '是否合格', width: 100,
                    styler: function (value, row, index) {
                        if (value == "不合格") {
                            return 'color:red;';
                        }
                    }
                },
                { field: 'SYRQ', title: '试验日期', width: 100, align: 'center', formatter: QBO.plu.grid.formatShortDate },
                { field: 'Oper', title: '操作', width: 100, align: 'center', formatter: formatOper },
                //{ field: 'KYLZ', title: '荷载值', width: 400 },
            ],
            toolbar: 'toolBarMain',
            onLoadSuccess: function (data) {
                //console.log(JSON.stringify(data));
                //if (isload == 0 && data.rows.length > 0) {
                //    //var rows = $.extend(true, [], data.rows);
                //    isload = 1;
                //    data.rows = filterData(data.rows);
                //    gridObj.datagrid('loadData', data);
                //}
                $("span.eui-opt-acc").imgPreview();
            }
        });
    }

    function initEvent() {
        $('#lbtnSearch').linkbutton({ onClick: function () { doHanlder('search'); } });
    }

    function doHanlder(type) {
        switch (type) {
            case 'search':
                queryData();
                break;
        }
    }

    //查看
    function ViewWin(id, url) {

        var newurl = url + "/Module/Caiji/KY_HNT.aspx?syjid=" + id + "&sylx=100014";

        QBO.frm.openWin(newurl, { title: '查看详细', isFull: true });
    }

    function formatOper(value, row, index) {
        var name = "<i class=\'fa fa-file-text-o\' title=\'查看\' style=\'color: rgb(80, 185, 255);\'></i>"

        var R_Value = "<a href=\'#\' onclick=\'ViewWin(\"" + row.SYJID + "\",\"" + row.URL + "\")\'>" + name + "</a>";

        return R_Value;

    }

    //重新过滤
    function filterData(rows) {
               
        for (var key = 0; key < rows.length; key++) {
            var row = rows[key];
            row.Field1 = "";
            row.Field2 = "";
            row.Field3 = "";

            var kylz = row.KYLZ;//荷载值910.6，824.5，739.8
            var sjcc = row.SJCC;//150×150×150
			if (sjcc == "150mm×150mm" || sjcc == "150mm×150mm×150mm") {
                sjcc = "150×150×150";
            }
            try {

                if (kylz !== null && kylz !== undefined && kylz !== '') {

                    var arr_kylz = kylz.split('，');

                    if (arr_kylz.length >= 3) {

                        var area = GetNum(sjcc);//150×150×150=3375000

                        var arr = new Array(3);
                        for (var i = 0; i < 3; i++) {

                            arr[i] = GetDataOddIncreaseEvenDecrease((parseFloat(arr_kylz[i]) * 1000 / area), -1);
                        }

                        arr.sort(function (a, b) { return a > b ? 1 : -1 });

                        if (((arr[1] - arr[0]) > 0.15 * arr[1] || (arr[2] - arr[1]) > 0.15 * arr[1]) && !((arr[1] - arr[0]) > 0.15 * arr[1] && (arr[2] - arr[1]) > 0.15 * arr[1])) {
                            row.Field1 = arr[1];
                            //global_msg = "混凝土抗压强度试验[最大值，或最小值与中值之差超过中值的15%，系统将取中值作为结果]";
                        }
                        else if ((arr[1] - arr[0]) > 0.15 * arr[1] && (arr[2] - arr[1]) > 0.15 * arr[1]) {
                            row.Field1 = "";
                            //global_msg = "混凝土抗压强度试验平行试验超差[最大值和最小值均超过中值的15%]，请重试！";
                        }
                        else {
                            row.Field1 = GetDataOddIncreaseEvenDecrease(((parseFloat(arr[0]) + parseFloat(arr[1]) + parseFloat(arr[2])) / 3), -1);
                        }

                        var sjqd = parseFloat(row.SJQD.replace("C", ""));//强度等级class="btn btn-danger"

                        if (row.Field1 != "") {
                            row.Field2 = (row.Field1 / sjqd * 100).toFixed(2);
                            row.Field3 = (row.LQ != 28?"-":(row.Field2 > 100 ? "合格" : "不合格"));
                        } else {
                            row.Field1 = "";
                            row.Field2 = "";
                            row.Field3 = "";
                        }

                    } else {
                        row.Field1 = "";
                        row.Field2 = "";
                        row.Field3 = "";
                    }
                }
                else {
                    row.Field1 = "";
                    row.Field2 = "";
                    row.Field3 = "";
                }
            } catch (e) {
                row.Field1 = "";
                row.Field2 = "";
                row.Field3 = "";
            }

            //console.log(key + "abc")

            //var show1 = true;
            //var show2 = true;
                       
            //if (paramsData.StartScale != "") {
            //    if (row.Field2 != "") {
            //        show1 = true;
            //    } else {
            //        show1 = false;
            //    }
               
            //    if (row.LQ==28 && parseFloat(row.Field2) >= parseFloat(paramsData.StartScale)) {
            //        show1 = true;
            //    }
            //    else {
            //        show1 = false;
            //    }
            //}

            //if (paramsData.EndScale != "" ) {
            //    if (row.Field2 != "") {
            //        show2 = true;
            //    } else {
            //        show2 = false;
            //    }

            //    if (row.LQ == 28 && parseFloat(row.Field2) <= parseFloat(paramsData.EndScale)) {
            //        show2 = true;
            //    }
            //    else {
            //        show2 = false;
            //    }
            //}
            
            //if (show1 && show2) {
            //    r_data.push(row);
            //}
            

        }

        //console.log(JSON.stringify(rows));
        
        return rows;

    }

    //抗压强度(MPa)
    function formatMPa(value, row, index) {

        var r_value1 = "";
        var r_value2 = "";
        var r_value3 = "";

        try {

            var kylz = row.KYLZ;//荷载值910.6，824.5，739.8
            var sjcc = row.SJCC;//150×150×150
			if (sjcc == "150mm×150mm" || sjcc == "150mm×150mm×150mm") {
                sjcc = "150×150×150";
            }
            if (kylz !== null && kylz !== undefined && kylz !== '') {

                var arr_kylz = kylz.split('，');

                if (arr_kylz.length >= 3) {

                    var area = GetNum(sjcc);//150×150×150=3375000

                    var arr = new Array(3);
                    for (var i = 0; i < 3; i++) {

                        arr[i] = GetDataOddIncreaseEvenDecrease((parseFloat(arr_kylz[i]) * 1000 / area), -1);
                    }

                    arr.sort(function (a, b) { return a > b ? 1 : -1 });

                    if (((arr[1] - arr[0]) > 0.15 * arr[1] || (arr[2] - arr[1]) > 0.15 * arr[1]) && !((arr[1] - arr[0]) > 0.15 * arr[1] && (arr[2] - arr[1]) > 0.15 * arr[1])) {
                        r_value1 = arr[1];
                        //global_msg = "混凝土抗压强度试验[最大值，或最小值与中值之差超过中值的15%，系统将取中值作为结果]";
                    }
                    else if ((arr[1] - arr[0]) > 0.15 * arr[1] && (arr[2] - arr[1]) > 0.15 * arr[1]) {
                        r_value1 = "";
                        //global_msg = "混凝土抗压强度试验平行试验超差[最大值和最小值均超过中值的15%]，请重试！";
                    }
                    else {
                        r_value1 = GetDataOddIncreaseEvenDecrease(((parseFloat(arr[0]) + parseFloat(arr[1]) + parseFloat(arr[2])) / 3), -1);
                    }
                                        
                    var sjqd = parseFloat(row.SJQD.replace("C", ""));//强度等级

                    if (r_value1 != "") {
                        r_value2 = (r_value1 / sjqd * 100).toFixed(2);
                        r_value3 = (row.LQ != 28 ? "-" : (r_value2 > 100 ? "合格" : "不合格"));
                    }

                } else {
                    r_value1 = "";
                    r_value2 = "";
                    r_value3 = "";
                }
            }
            else {
                r_value1 = "";
                r_value2 = "";
                r_value3 = "";
            }

        } catch (e) {
            r_value1 = "";
            r_value2 = "";
            r_value3 = "";
        }
        
        row.Field1 = r_value1;
        row.Field2 = r_value2;
        row.Field3 = r_value3;

        return r_value1;
    }

</script>


@*扩展定义*@
<script type="text/javascript">

    function dateformatter(date) {
        var y = date.getFullYear();
        var m = date.getMonth();
        var d = date.getDate();
        return y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d);
    }

    function DateAdd(interval, number, date) {
        /*
          *   功能:实现VBScript的DateAdd功能.
          *   参数:interval,字符串表达式，表示要添加的时间间隔.
          *   参数:number,数值表达式，表示要添加的时间间隔的个数.
          *   参数:date,时间对象.
          *   返回:新的时间对象.
          *   var   now   =   new   Date();
          *   var   newDate   =   DateAdd( "d ",5,now);
          *---------------   DateAdd(interval,number,date)   -----------------
          */
        switch (interval) {
            case "y ": {
                date.setFullYear(date.getFullYear() + number);
                return date;
                break;
            }
            case "q ": {
                date.setMonth(date.getMonth() + number * 3);
                return date;
                break;
            }
            case "m ": {
                date.setMonth(date.getMonth() + number);
                return date;
                break;
            }
            case "w ": {
                date.setDate(date.getDate() + number * 7);
                return date;
                break;
            }
            case "d ": {
                date.setDate(date.getDate() + number);
                return date;
                break;
            }
            case "h ": {
                date.setHours(date.getHours() + number);
                return date;
                break;
            }
            case "m ": {
                date.setMinutes(date.getMinutes() + number);
                return date;
                break;
            }
            case "s ": {
                date.setSeconds(date.getSeconds() + number);
                return date;
                break;
            }
            default: {
                date.setDate(d.getDate() + number);
                return date;
                break;
            }
        }
    }


</script>