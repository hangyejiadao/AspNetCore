@{
    ViewBag.Title = "EChartIndex2";
    Layout = "~/Views/BasePage/_LayoutMsSysEmpty.cshtml";
}


<link href="~/Content/Components/echars/css/style.min.css" rel="stylesheet" />
<link href="~/Content/assets/global/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

<script src="~/Content/Components/echars/echarts.js"></script>
<script src="~/Content/Components/echars/theme/walden.js"></script>

<script src="~/Content/Components/AngularJS/angular.min.js"></script>

<style type="text/css">
    body {
        background-color: rgb(240, 245, 246);
    }

    .ibox-title {
        padding: 5px 5px;
        min-height: 40px;
    }

    .ibox-content {
        padding: 5px 5px;
        height: auto;
    }

    .ibox_echart {
        min-height: 500px;
    }


    .ibox-body {
        position: absolute;
        top: 5px;
        width: 100%;
        height: 99%;
        overflow-x: hidden;
        overflow-y: auto;
    }

    .btn-default {
        color: #02a9f3;
        background-color: #fff;
        border: 1px solid #02a9f3;
    }

    .btn-primary {
        color: #fff;
        background-color: #02a9f3;
        border: 1px solid #02a9f3;
    }

        .btn-primary.focus, .btn-primary:focus {
            color: #fff;
            background-color: #02a9f3;
            border: 1px solid #02a9f3;
        }

    .kx-search { 
        background-color:#eee;
        border: 1px solid #ccc;
        color:#313131
    }
    .kx-search:focus { 
        background-color:#eee;
        border: 1px solid #ccc;
        color:#313131
    }
    .form-inline .btn:hover {
        background:#0da6ea;
        border-color:#0da6ea;
        color:#fff;
    }
</style>

<div ng-app="pageApp" ng-controller="pageCtrl">

    <div class="container-fluid ibox-body">

        <div class="row">

            <div class="col-sm-12 col-xs-12 col-md-12 col-lg-12">

                <div class="ibox-title form-inline " style="text-align: left;">
                                   

                    <div class="form-group input-group-sm">

                        <input id="F_QueryDate" type="text" class="easyui-datebox" data-options="required:false,width:100,height:28,readonly:false,disabled:false,editable:false" />


                        <select id="F_StartHour" style="width:40px; height:28px">
                            <option selected="selected" value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                        </select>

                        至

                        <select id="F_EndHour" style="width:40px; height:28px">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option selected="selected" value="24">24</option>
                        </select>
                        点
                    </div>
                                       
                    
                    <div class="form-group input-group-sm">
                        <a href="javascript:;" class="btn btn-sm btn-primary kx-search" ng-click="queryEchartData()">查询</a>
                    </div>
                    
                    <div class="form-group input-group-sm">
                        <a href="javascript:;" style="margin-left:5px" ng-repeat="item in items"
                           ng-class="{true:'btn btn-sm btn-primary',false:'btn btn-sm btn-default'}[item.BlendNO==paramsData.BHJBH]" ng-click="selectBhzItem(item.BlendNO)">
                            {{::item.BlendName}}
                        </a>
                    </div>

                </div>

            </div>

        </div>

        <div class="row">
            <div class="col-sm-12 col-xs-12 col-md-12 col-lg-12">
                <div class="ibox-content">
                    <div id="div_one" class="ibox_echart" ng-if="eChart_Data.Result">
                    </div>
                    <div class="ibox_echart" ng-if="!eChart_Data.Result">
                        <p class="text-center" style="font-size: 18px; padding-top: 150px; text-align: center">无数据！</p>
                    </div>
                </div>


            </div>
        </div>


    </div>

</div>


<script type="text/javascript">


    var paramsData = {
        "LoadApi": '@ViewBag.LoadApi',
        "OrganID": "",
        "BhzApi": "",
        "BHJBH": '',
        "QueryDate": '',
        "StartHour":1,
        "EndHour": 24
    }


    $(function () {

    });


    function SetTime() {
        var curr_time = new Date();        
        var next_time = DateAdd("m ", 1, new Date());
        $('#F_QueryDate').datebox('setValue', dateformatter(next_time));
    };


    function ModuleQuery(data) {
        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        $scope.paramsData.LoadApi = 1;
        $scope.paramsData.OrganID = data.TargetId;
        $scope.paramsData.BhzApi = data.ExtraData;
        $scope.getCookieData();
        $scope.$apply();
        $scope.loadBhzData();  
    }


</script>


<script type="text/javascript">

    //初始化Angular
    var pageApp = angular.module('pageApp', []);
    pageApp.controller('pageCtrl', function ($scope, $http, $timeout) {
        initNgData($scope, $http);
        initNgEvent($scope, $http, $timeout);
        initNgQuery($scope, $http, $timeout);
    });

    //初始化ng数据
    function initNgData($scope, $http) {

        $scope.paramsData = paramsData;
        $scope.paramsData.OrganID = parent.selData.TargetId;
        $scope.paramsData.BhzApi = parent.selData.ExtraData;

        var idxData = parent.idxData;
        if (idxData.idx_mod1 == 2 && idxData.idx_mod2 == 1) {
            $scope.paramsData.LoadApi = 1;
        } else {
            $scope.paramsData.LoadApi = 0;
        }

        $scope.items = [];
        $scope.eChart_Data = { Result: true };
      
        SetTime();
    }

    //初始化ng事件
    function initNgEvent($scope, $http, $timeout) {

        //产能分析统计
        $scope.queryEchartData = function () {

            var QueryDate = $('#F_QueryDate').datebox('getValue');
            var StartHour = $('#F_StartHour').val();
            var EndHour = $('#F_EndHour').val();
            $scope.paramsData.QueryDate = QueryDate;
            $scope.paramsData.StartHour = StartHour;
            $scope.paramsData.EndHour = EndHour;

            if ($scope.paramsData.LoadApi == 0) return;

            QBO.plu.ng.http({ http: $http, isLoad: false, chkLogin: true, url: '/MsSys/ECharts/GetEChartsAnalyze2', params: $scope.paramsData }, function (data) {
               
                if (data != "") {
                    $scope.eChart_Data = JSON.parse(data);
                    if ($scope.eChart_Data.Result) {
                        $timeout(function () {
                            setOption_OneData($scope);
                        });
                    }
                }
                else {
                    $scope.eChart_Data.Result = false;
                }

            });

        };

        //获取拌合机
        $scope.loadBhzData = function () {
            $scope.items = [];
            var params = { BhzApi: $scope.paramsData.BhzApi, TargetId: $scope.paramsData.OrganID };

            QBO.plu.ng.http({ http: $http, isLoad: true, chkLogin: false, url: '/MsSys/BhzOper/GetBhzBhjList', params: params }, function (result) {
            
                $scope.items = result;
                var bhzNo = QBO.plu.cookie.get($scope.paramsData.OrganID);
                if (bhzNo != '') {
                    $scope.paramsData.BHJBH = bhzNo;
                }
                else {
                    if ($scope.items != null && $scope.items.length > 0) {
                        $scope.paramsData.BHJBH = $scope.items[0].BlendNO;
                    }
                }

                if ($scope.items != null && $scope.items.length > 0) {
                    $scope.queryEchartData();
                } else {
                    $scope.eChart_Data.Result = false;
                }
            });

        }
  
        //选择拌合机
        $scope.selectBhzItem = function (bhzNo) {
            $scope.paramsData.BHJBH = bhzNo;
            $scope.queryEchartData();
            QBO.plu.cookie.set($scope.paramsData.OrganID, bhzNo, { expires: 7, path: '/' });
        };

        //获取拌合机cookie
        $scope.getCookieData = function () {            
            var bhzNo = QBO.plu.cookie.get($scope.paramsData.OrganID);
            if (bhzNo != '') {
                $scope.paramsData.BHJBH = bhzNo;
            }
        }

    }

    //初始化ng查询数据
    function initNgQuery($scope, $http, $timeout) {
        var BhzApi = $scope.paramsData.BhzApi;
        if (BhzApi == null || BhzApi == "") {
            return;
        }

        $scope.getCookieData();

        $scope.loadBhzData();
    }


    function setOption_OneData($scope) {
        $scope.eChart_Data.ECharts.toolbox = {
            show: true,
            feature: {
                dataView: {
                    show: true,
                    readOnly: true,
                    lang: [$scope.eChart_Data.ECharts.title.text, '关闭', '刷新'],
                    optionToContent: function (opt) {
                        var series = opt.series;
                        var table = '<div style="height: 100%;overflow-y:auto"><table class="table table-striped table-condensed" >'
                                    + '<thead><tr><th>时间</th>'
                                    + '<th>' + series[0].name + '</th>'
                                    + '<th>' + series[1].name + '</th>'
                                    + '<th>' + series[2].name + '</th>'
                                    + '<th>' + series[3].name + '</th>'
                                    + '<th>' + series[4].name + '</th>'
                                    + '<th>' + series[5].name + '</th>'
                                    + '<th>' + series[6].name + '</th>'
                                    + '<th>' + series[7].name + '</th>'
                                    + '<th>' + series[8].name + '</th>'
                                    + '<th>' + series[9].name + '</th>'
                                    + '<th>' + series[10].name + '</th>'
                                    + '<th>' + series[11].name + '</th>'
                                    + '</tr></thead>';

                        table += '<tbody>';
                        for (var i in series[0].data) {
                            table += '<tr>'
                                  + '<td>' + series[0].data[i].name + '</td>'
                                  + '<td>' + series[0].data[i].value + 'kg</td>'
                                  + '<td>' + series[1].data[i].value + 'kg</td>'
                                  + '<td>' + series[2].data[i].value + 'kg</td>'
                                  + '<td>' + series[3].data[i].value + 'kg</td>'
                                  + '<td>' + series[4].data[i].value + 'kg</td>'
                                  + '<td>' + series[5].data[i].value + 'kg</td>'
                                  + '<td>' + series[6].data[i].value + 'kg</td>'
                                  + '<td>' + series[7].data[i].value + 'kg</td>'
                                  + '<td>' + series[8].data[i].value + 'kg</td>'
                                  + '<td>' + series[9].data[i].value + 'kg</td>'
                                  + '<td>' + series[10].data[i].value + 'kg</td>'
                                  + '<td>' + series[11].data[i].value + 'kg</td>'
                                  + '</tr>';
                        }

                        table += '</tbody></table></div>';
                        return table;


                    }
                },
                magicType: { show: true, type: ['line', 'bar'] },
                restore: { show: true },
                saveAsImage: {
                    show: true,
                    backgroundColor: 'white'
                }
            }
        };
        var myChart_One = echarts.init(document.getElementById('div_one'), "walden");
        

        //var series = $scope.eChart_Data.ECharts.series;
        //for (var key in series) {
        //    series[key].label.normal.formatter = function (params) {
        //        return (params.value || 0).toString().replace(/(\d)(?=(?:\d{3})+$)/g, '$1,');
        //    };
        //}


        myChart_One.setOption($scope.eChart_Data.ECharts);

        //console.log(JSON.stringify($scope.eChart_Data.ECharts))

    }


</script>


@*扩展定义*@
<script type="text/javascript">

    function dateformatter(date) {
        var y = date.getFullYear();
        var m = date.getMonth();
        var d = date.getDate();
        return y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d);
    }

    function DateAdd(interval, number, date) {
        /*
          *   功能:实现VBScript的DateAdd功能.
          *   参数:interval,字符串表达式，表示要添加的时间间隔.
          *   参数:number,数值表达式，表示要添加的时间间隔的个数.
          *   参数:date,时间对象.
          *   返回:新的时间对象.
          *   var   now   =   new   Date();
          *   var   newDate   =   DateAdd( "d ",5,now);
          *---------------   DateAdd(interval,number,date)   -----------------
          */
        switch (interval) {
            case "y ": {
                date.setFullYear(date.getFullYear() + number);
                return date;
                break;
            }
            case "q ": {
                date.setMonth(date.getMonth() + number * 3);
                return date;
                break;
            }
            case "m ": {
                date.setMonth(date.getMonth() + number);
                return date;
                break;
            }
            case "w ": {
                date.setDate(date.getDate() + number * 7);
                return date;
                break;
            }
            case "d ": {
                date.setDate(date.getDate() + number);
                return date;
                break;
            }
            case "h ": {
                date.setHours(date.getHours() + number);
                return date;
                break;
            }
            case "m ": {
                date.setMinutes(date.getMinutes() + number);
                return date;
                break;
            }
            case "s ": {
                date.setSeconds(date.getSeconds() + number);
                return date;
                break;
            }
            default: {
                date.setDate(d.getDate() + number);
                return date;
                break;
            }
        }
    }


</script>
