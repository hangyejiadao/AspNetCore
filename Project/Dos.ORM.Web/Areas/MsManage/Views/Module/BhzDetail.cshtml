@{
    ViewBag.Title = "BhzDetail";
    Layout = "~/Views/BasePage/_LayoutMsSysDetailSingle.cshtml";
}

@*<script src="~/Content/Components/Validator/jquery.validator.min.js?local=zh-CN"></script>*@
<script src="~/Content/Components/AngularJS/angular.min.js"></script>

<form class="easyui-form" id="thisForm" method="post" enctype="multipart/form-data" style="width: 100%; height:100%"
      ng-app="pageApp" ng-controller="pageCtrl">

    <div title="软件分类" style="overflow-y: auto;">

        <table class="frm-tb">
            <tbody>              
                <tr>
                    <td>名称：</td>
                    <td>
                        <input name="BlendName" class="txt-main" ng-model="model.BhzModel.BlendName" data-rule="名称:required;length[1~120]:BlendName" style="width: 300px;height:26px">
                    </td>
                </tr>
                <tr>
                    <td>编号：</td>
                    <td>
                        <input name="BlendNO" class="txt-main" ng-model="model.BhzModel.BlendNO" data-rule="编号:required;length[1~60]:BlendNO" style="width: 300px;height:26px">
                    </td>
                </tr>
                <tr>
                    <td>类型：</td>
                    <td>
                        <input type="radio" name="TypeName" id="rd_two"
                               ng-checked="!model.SuperDisable" ng-click="selectTypeItem(false,$event)" /><label for="rd_two">拌合机</label>

                        <input type="radio" name="TypeName" id="rd_one"
                               ng-checked="model.SuperDisable" ng-click="selectTypeItem(true,$event)" /><label for="rd_one">拌合站</label>
                        
                </td>
                </tr>
                <tr ng-if="!model.SuperDisable">
                    <td>拌合站：</td>
                    <td>
                        <select name="ParentID" class="txt-main" data-rule="拌合站:required;length[1~120]:ParentID" style="width: 300px;height:26px"
                                ng-model="model.BhzModel.ParentID" ng-change="selectBhzItem($event)">
                            <option value="{{item.ID}}" ng-repeat="item in model.Supers" ng-selected="item.ID==model.BhzModel.ParentID">{{item.BlendName}}</option>
                        </select>
                    </td>
                </tr>
                <tr ng-if="model.SuperDisable">
                    <td>试验室：</td>
                    <td>
                        <input name="OrganName" class="txt-main" style="width: 300px;height:26px" ng-readonly="true" ng-click="selectCustItem()" 
                               ng-model="model.BhzModel.OrganName" data-rule="试验室:required;length[1~200]:OrganName">
                        <a href="javascript:;" class="easyui-linkbutton" ng-click="SelectTarget()" data-options="iconCls:'fa fa-search-plus',plain:true">选择</a>

                    </td>
                </tr>
                <tr>
                    <td>备注：</td>
                    <td>
                        <textarea name="Memo" class="txta-main" ng-model="model.BhzModel.Memo" data-rule="length[1~200]" style="width: 300px; height: 50px; "></textarea>
                    </td>
                </tr>
            </tbody>
        </table>

    </div>

</form>



<script>


    var thisForm = $("#thisForm"), oType = '@ViewBag.oType', keyId = '@ViewBag.keyId';

    //初始化Angular
    var pageApp = angular.module('pageApp', []);
    pageApp.controller('pageCtrl', function ($scope, $http, $sce) {
        initNgData($scope, $http);
        initNgEvent($scope, $http, $sce);
    });

    //初始化ng数据
    function initNgData($scope, $http) {
        $scope.model = {};
        QBO.plu.ng.http({ http: $http, method: 'POST', isLoad: false, url: 'GetBhzByID', params: { oType: oType, keyId: keyId } }, function (data) {
            $scope.model = data;

            //console.log(JSON.stringify($scope.model));
        });
    }

    //初始化ng事件
    function initNgEvent($scope, $http, $sce) {
        

        $scope.selectBhzItem = function ($event) {
                     var parentId= $scope.model.BhzModel.ParentID;
            var supers = $scope.model.Supers;

            for (var key in supers) {

                if (supers[key].ID == parentId)
                {
                    $scope.model.BhzModel.OrganID = supers[key].OrganID;
                }

            }


        }

        //选择类型
        $scope.selectTypeItem = function (value, $event) {

            $scope.model.SuperDisable = value;

            //拌合站
            if (value)
            {
                $scope.model.BhzModel.ParentID = null;
                $scope.model.BhzModel.OrganID = null;
                $scope.model.BhzModel.OrganName = null;
            }

        }
        //选择试验室
        $scope.SelectTarget = function () {
            QBO.frm.openWin('/MsManage/Shared/SelectTarget?OperType=1&IsMulti=0', { title: '选择试验室', width: 720, height: 500 });
        }

    }


    //保存数据
    function saveData() {

        //表单验证不通过
        //if (!QBO.frm.chkForm()) { return; }

        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();

        var model = angular.copy($scope.model);
        model.Supers = null;
        model.Labs = null;

        console.log(JSON.stringify(model))
      
        if (model.BhzModel.BlendName == null || model.BhzModel.BlendName == '') {
            QBO.dia.msg('请填写名称！', 'info');
            return;
        }

        if (model.BhzModel.BlendNO == null || model.BhzModel.BlendNO == '') {
            QBO.dia.msg('请填写编号！', 'info');
            return;
        }

        //拌合站
        if (model.SuperDisable && model.BhzModel.OrganID == null) {
            QBO.dia.msg('请选择试验室！', 'info');
            return;
        }
      
        //拌合机        
        if (!model.SuperDisable && model.BhzModel.ParentID == null) {
            QBO.dia.msg('请选择拌合站！', 'info');
            return;
        }    

  

        QBO.plu.ajax({
            isLoad: true,
            type: 'POST',
            data: { ModelData: JSON.stringify(model) },
            url: 'SaveBhzData'
        }, function (result) {
            QBO.dia.msg(result.Msg, {
                icon: result.Result === 100 ? 'right' : 'error',
                endCallback: function () {
                    if (result.Result === 100) { QBO.frm.closeWin(function () { QBO.frm.getWin().reloadGridData('tg'); }); }
                }
            });

        });


    }


    //选择试验室回调
    function SelectTarget_Callback(item) {
        var appElement = document.querySelector('[ng-controller=pageCtrl]');
        var $scope = angular.element(appElement).scope();
        $scope.model.BhzModel.OrganID = item[0].TargetId;
        $scope.model.BhzModel.OrganName = item[0].TargetName;
        $scope.$apply();

        return true;
    }

</script>



