@using Dos.ORM.Web.App_Common.Mvc
@model Dos.ORM.Model.Business.BUS_Role
@{
    ViewBag.Title = "角色管理";
    Layout = "~/Views/BasePage/_LayoutMsSysDetailSimple.cshtml";
}

<style>
    .role-type {
        padding: 5px 0 5px 10px;
        border-bottom: 1px dashed #c2c2c2;
    }

    .role-select {
        padding: 5px 0 0 10px;
    }
</style>
<script src="~/Content/Components/zTree/js/jquery.ztree.core.min.js"></script>
<script src="~/Content/Components/zTree/js/jquery.ztree.excheck.min.js"></script>
<div data-options="region:'west',border:false,split:true" style="width: 255px;">
    <div class="role-select">
        @Html.ExtLinkButton("modAll", new { text = "全选", iconCls = "icon-apply", onClick = "function(){QBO.plu.zt.checkAll('zTreePanel');}" })
        @Html.ExtLinkButton("modAllCancel", new { text = "取消全选", iconCls = "icon-cancel", onClick = "function(){QBO.plu.zt.checkAll('zTreePanel',false);}" })
    </div>
    <ul id="zTreePanel" class="ztree"></ul>
</div>
<div data-options="region:'south',border:false" class="frm-toolbar">
    @Html.ExtAuthBtn()
</div>
<div data-options="region:'center',border:false">
    <form class="easyui-form" id="frmMain" method="post">
        <table class="frm-tb">
            <tbody>
                <tr>
                    <td>模块名称：</td>
                    <td>
                        @Html.ExtTextBoxFor(m => m.RoleName, new { required = true, validType = "maxLength[50]", width = 300 })
                    </td>
                </tr>
                <tr>
                    <td>排序：</td>
                    <td>
                        @Html.ExtTextBoxFor(m => m.Order, new { width = 300 })
                    </td>
                </tr>
                <tr>
                    <td>备注：</td>
                    <td>@Html.ExtTextBoxFor(m => m.Note, new { validType = "maxLength[200]", width = 300, multiline = true })</td>
                </tr>
            </tbody>
        </table>
    </form>
</div>
<script>
    var thisForm, oType = '@ViewBag.oType', keyId = '@ViewBag.keyId';

    $(function () {
        initData();
    });

    function initData() {
        thisForm = $('#frmMain');
        getModules(0);
    }

    function saveData() {
        if (QBO.plu.zt.get('zTreePanel').str.length <= 0) {
            QBO.dia.confirm('当前未选择包含的模块，确定要继续？', function () {
                saveModule();
            });
        } else {
            saveModule(true);
        }
    }

    //获取左侧模块树
    function getModules(type) {
        QBO.plu.ajax({
            url: '/MsManage/Role/GetModule',
            data: { moduleType: type, keyId: keyId }
        }, function (data) {
            QBO.plu.zt.init('zTreePanel',
                data,
                {
                    check: true,
                    chkboxTypeY: 'ps',
                    chkboxTypeN: 'ps'
                });
        });
    }

    function saveModule(isSavePId) {
        QBO.frm.submit(thisForm, {
            url: '/MsManage/Role/SaveData',
            onSubmit: function (param) {
                //模块Id集合
                if (isSavePId && QBO.plu.zt.get('zTreePanel').str.length > 0) {
                    param.moduleIds = QBO.plu.zt.get('zTreePanel').str;
                }
            },
            success: function (data) {
                QBO.dia.msg(data.Msg, {
                    icon: data.Result === 100 ? 'right' : 'error',
                    endCallback: function () {
                        if (data.Result === 100) { QBO.frm.closeWin(function () { QBO.frm.getWin().reloadGridData(); }); }
                    }
                });
            }
        });
    }
</script>
