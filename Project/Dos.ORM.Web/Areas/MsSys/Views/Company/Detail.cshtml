@using Dos.ORM.Web.App_Common.Mvc
@model Dos.ORM.Model.System.SYS_Company
@{
    ViewBag.Title = "公司管理";
    Layout = "~/Views/BasePage/_LayoutMsSysDetailSingle.cshtml";
}
<script src="~/Content/Components/UEditor/ueditor.config.js"></script>
<script src="~/Content/Components/UEditor/ueditor.all.min.js"></script>
<script src="~/Content/Components/UEditor/lang/zh-cn/zh-cn.js"></script>
<form class="easyui-form" id="frmMain" method="post">
    <div class="easyui-tabs" style="width:100%;height:350px;">
        <div title="基本信息">
            <table class="frm-tb">
                <tbody>
                    <tr class="tr-top-none">
                        <td>
                            公司名称：
                        </td>
                        <td colspan="3">
                            @Html.ExtTextBoxFor(m => m.CompanyName, new { required = true, width = 696, validType = "maxLength[100]" })
                        </td>
                    </tr>
                    @{
                        if (ViewBag.AccountType == 1)
                        {
                            <tr>
                                <td>上级公司：</td>
                                <td colspan="3">
                                    @*@Html.ExtDropDownForC(m => m.ParentId, new { width = 600, url = "/MsSys/Company/GetCompanyList", queryParams = "{curComId:'" + Model.CompanyId + "',haveComId:0}" })*@
                                    @Html.ExtComboTreeFor(m => m.ParentId, new { width = 696, url = "/MsSys/Company/GetChooseCompanys", queryParams = "{type:2}" })

                                    @*@Html.ExtTextBox("ParentName", new { width = 518, @readonly = true })
                                        <input type="hidden" name="ParentId" id="ParentId" value="" />
                                        <a href="javascript:;" class="easyui-linkbutton" id="lbtnCom" data-options="iconCls:'fa fa-edit',plain:true">选择公司</a>*@
                                </td>
                            </tr>
                        }
                    }
                    <tr>
                        <td>公司Logo：</td>
                        <td colspan="3">
                            @Html.HiddenFor(m => m.LogoPath)
                            @Html.ExtNumberSpinnerFor(m => m.LogoWidth, new { min = 100, max = 600, value = 100, buttonText = "Logo宽度" })
                            @Html.ExtNumberSpinnerFor(m => m.LogoHeight, new { min = 100, max = 600, value = 100, buttonText = "Logo高度" })
                            @Html.ExtImgFor(m => m.LogoPath)
                            <a href="javascript:;" class="easyui-linkbutton" id="lbtnLogo" data-options="iconCls:'fa fa-image',plain:true">点击修改</a>
                        </td>
                    </tr>
                    <tr>
                        <td>联系人：</td>
                        <td>@Html.ExtTextBoxFor(m => m.ConMan, new { validType = "maxLength[100]" })</td>
                        <td>手机号码：</td>
                        <td>@Html.ExtTextBoxFor(m => m.Mobile, new { validType = "mobile" })</td>
                    </tr>
                    <tr>
                        <td>联系电话：</td>
                        <td>@Html.ExtTextBoxFor(m => m.Tel, new { validType = "tel" })</td>
                        <td>邮箱地址：</td>
                        <td>@Html.ExtTextBoxFor(m => m.Email, new { validType = "email" })</td>
                    </tr>
                    <tr>
                        <td>微信：</td>
                        <td>@Html.ExtTextBoxFor(m => m.WeChat, new { validType = "maxLength[100]" })</td>
                        <td>微博：</td>
                        <td>@Html.ExtTextBoxFor(m => m.Microblog, new { validType = "maxLength[100]" })</td>
                    </tr>
                    <tr>
                        <td>省市县镇：</td>
                        <td colspan="3">
                            @Html.ExtDropDownForC(m => m.ProvinceId, new { width = 100, url = "/MsSys/Common/GetAreaCode", queryParams = "{type:1,level:1,areaCode:0}", valueField = "AreaCode", textField = "AreaName", onChange = "onSelectChgProvince" })
                            @Html.ExtDropDownForC(m => m.CityId, new { width = 100, url = "/MsSys/Common/GetAreaCode", queryParams = "{type:2,level:2,areaCode:0}", valueField = "AreaCode", textField = "AreaName", onChange = "onSelectChgCity" })
                            @Html.ExtDropDownForC(m => m.CountyId, new { width = 100, url = "/MsSys/Common/GetAreaCode", queryParams = "{type:2,level:3,areaCode:0}", valueField = "AreaCode", textField = "AreaName", onChange = "onSelectChgCounty" })
                            @Html.ExtDropDownForC(m => m.TownId, new { width = 100, url = "/MsSys/Common/GetAreaCode", queryParams = "{type:2,level:4,areaCode:0}", valueField = "AreaCode", textField = "AreaName", onChange = "onSelectChgTown" })
                        </td>
                    </tr>
                    <tr>
                        <td>详细地址：</td>
                        <td colspan="3">@Html.ExtTextBoxFor(m => m.Address, new { width = 696, validType = "maxLength[200]" })</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div title="其他信息">
            <table class="frm-tb">
                <tbody>
                    <tr class="tr-top-none">
                        <td>经度纬度：</td>
                        <td colspan="3">
                            @Html.ExtTextBoxFor(m => m.Lng, new { @readonly = true, buttonText = "经度" })
                            @Html.ExtTextBoxFor(m => m.Lat, new { @readonly = true, buttonText = "纬度" })
                            <a href="javascript:;" class="easyui-linkbutton" id="lbtnCoor" data-options="iconCls:'icon-find',plain:true">点击选择</a>
                        </td>
                    </tr>
                    <tr>
                        <td>详细信息：</td>
                        <td colspan="3">
                            <script id="editor" type="text/plain" style="width: 100%; height: 200px;">
                                @Html.Raw(Model.DtlInfo)
                            </script>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</form>
<script>
    var thisForm, oType = '@ViewBag.oType';
    var ueObj;

    $(function () {
        initData();
        initEvent();
    });

    function initData() {
        thisForm = $('#frmMain');

        if (oType !== 'add') {
            $('#CityId').combobox({ queryParams: { type: 1, level: 2, areaCode: $('#ProvinceId').combobox('getValue') } });
            $('#CountyId').combobox({ queryParams: { type: 1, level: 3, areaCode: $('#CityId').combobox('getValue') } });
            $('#TownId').combobox({ queryParams: { type: 1, level: 4, areaCode: $('#CountyId').combobox('getValue') } });
        } else {
            $('#CityId,#CountyId,#TownId').combobox('disable');
        }
    }

    function initEvent() {
        ueObj = QBO.plu.ue.init();

        @*$('#lbtnCom').on('click', function () {
            QBO.frm.openWin('/MsSys/Company/ChooseCompany?comId=@Model.ParentId', { title: '选择公司', width: 500, height: 500 });
        });*@

        $('#lbtnCoor').on('click', function () {
            QBO.frm.openWin('/MsSys/Company/Coor?lng=' + $('#Lng').textbox('getValue') + '&lat=' + $('#Lat').textbox('getValue'), { title: '选择坐标', width: 1000, height: 450 });
        });

        $('#lbtnLogo').on('click', function () {
            QBO.frm.openWin('/MsSys/Common/UploadImg?folder=SysCompany&isCut=1&cutWidth=200&cutHeight=100&oldPath=@Model.LogoPath', { title: '上传Logo', width: 1000, height: 450 });
        });
    }

    function saveData() {
        QBO.frm.submit(thisForm, {
            url: '/MsSys/Company/SaveData',
            onSubmit: function (param) {
                param.DtlInfo = QBO.plu.ue.get(ueObj);
            },
            success: function (data) {
                QBO.dia.msg(data.Msg, {
                    icon: data.Result === 100 ? 'right' : 'error',
                    endCallback: function () {
                        if (data.Result === 100) {
                            QBO.frm.closeWin(function () { QBO.frm.getWin().reloadGridData(); });
                        }
                    }
                });
            }
        });
    }

    function setImg(imgPath) {
        $('#LogoPathShow').attr('src', imgPath);
        $('#LogoPath').val(imgPath);
    }

    //设置坐标
    function setCoor(coorObj) {
        $('#Lng').textbox('setValue', coorObj.lng);
        $('#Lat').textbox('setValue', coorObj.lat);
    }

    //省市县镇选择事件
    function onSelectChgProvince(newValue, oldValue) {
        newValue = !newValue || newValue.length <= 0 ? 0 : newValue;

        $('#CityId').combobox({ queryParams: { type: 1, level: 2, areaCode: newValue } }).combobox('setValue', '-1').combobox('enable');
        $('#CountyId,#TownId').combobox('clear').combobox('setValue', '-1').combobox('disable');
    }
    function onSelectChgCity(newValue, oldValue) {
        newValue = !newValue || newValue.length <= 0 ? 0 : newValue;

        $('#CountyId').combobox({ queryParams: { type: 1, level: 3, areaCode: newValue } }).combobox('setValue', '-1').combobox('enable');
        $('#TownId').combobox('clear').combobox('setValue', '-1').combobox('disable');
    }
    function onSelectChgCounty(newValue, oldValue) {
        newValue = !newValue || newValue.length <= 0 ? 0 : newValue;

        $('#TownId').combobox({ queryParams: { type: 1, level: 4, areaCode: newValue } }).combobox('setValue', '-1').combobox('enable');
    }
    function onSelectChgTown(newValue, oldValue) {
    }
</script>